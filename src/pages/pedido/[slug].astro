---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Beneficios from "../../components/Beneficios.astro";
import { urls, get } from "../../lib/api.js";

const params = Astro.url.searchParams
const is_account = params.get('account')

const { slug } = Astro.params;
const res = await get(`${urls.socio_pedidos}/uno/${slug}`);

let pedido = null;
if (res.code === 0) {
    pedido = res.data;
}

// Etapas simuladas
const etapas = [
    { nombre: "Pedido recibido", fecha: "2025-10-31T21:22:13.000Z" },
    { nombre: "Pago confirmado", fecha: "2025-10-31T21:22:43.000Z" },
    { nombre: "Preparando pedido", fecha: null },
    { nombre: "Listo para entrega", fecha: null },
    { nombre: "Pedido completado", fecha: null },
];
---

<BaseLayout title={`Pedido: ${pedido?.codigo || ""}`}>
    <main class="w-full bg-gray-50 py-12 sm:py-16">
        <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-16">
            <div class="grid md:grid-cols-3 gap-8">
                <!-- Datos del pedido -->
                <section
                    class="md:col-span-2 bg-white p-8 rounded-2xl shadow-md space-y-6"
                >
                    <div class="flex justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800">
                                Pedido #{pedido.codigo}
                            </h2>
                            <p class="text-gray-500 text-sm">
                                {
                                    new Date(pedido.fecha).toLocaleDateString(
                                        "es-PE",
                                    )
                                }
                            </p>
                        </div>

                        <div>
                            <span
                                class="px-3 py-1 text-sm font-medium rounded-full"
                                class:list={[
                                    pedido.estado1.nombre === "ABIERTO"
                                        ? "bg-yellow-100 text-yellow-800"
                                        : pedido.estado1.nombre === "CERRADO"
                                          ? "bg-green-100 text-green-800"
                                          : "bg-gray-100 text-gray-800",
                                ]}
                            >
                                {pedido.estado1.nombre}
                            </span>
                        </div>
                    </div>

                    <div class="text-gray-700">
                        <p>
                            <span class="font-medium">Cliente:</span>
                            {pedido.socio_datos?.nombres}
                            {pedido.socio_datos?.apellidos}
                        </p>
                        <p>
                            <span class="font-medium">Documento:</span>
                            {pedido.socio_datos?.doc_tipo}
                            {pedido.socio_datos?.doc_numero}
                        </p>
                        <p>
                            <span class="font-medium">Correo:</span>
                            {pedido.socio_datos?.correo}
                        </p>
                        <p>
                            <span class="font-medium">Teléfono:</span>
                            {pedido.socio_datos?.telefono}
                        </p>
                    </div>

                    <div class="text-gray-700">
                        <p>
                            <span class="font-medium">Tipo de entrega:</span>
                            {pedido.entrega_tipo}
                        </p>

                        <p>
                            <span class="font-medium">Dirección:</span>
                            {pedido.direccion_entrega}
                            {
                                pedido.entrega_direccion_datos && (
                                    <>
                                        {pedido.entrega_direccion_datos
                                            .numero && (
                                            <>
                                                {" "}
                                                Nro:{" "}
                                                {
                                                    pedido
                                                        .entrega_direccion_datos
                                                        .numero
                                                }
                                            </>
                                        )}
                                        {pedido.entrega_direccion_datos
                                            .piso && (
                                            <>
                                                {" "}
                                                Piso:{" "}
                                                {
                                                    pedido
                                                        .entrega_direccion_datos
                                                        .piso
                                                }
                                            </>
                                        )}
                                    </>
                                )
                            }
                        </p>

                        <p>
                            <span class="font-medium">Distrito:</span>
                            {pedido.entrega_direccion_datos.ubigeo1.nombre}
                        </p>

                        <p>
                            <span class="font-medium">Referencia:</span>
                            {pedido.entrega_direccion_datos.referencia}
                        </p>
                    </div>

                    <div class="text-gray-700">
                        <p>
                            <span class="font-medium">Tipo de comprobante:</span
                            >
                            {pedido.comprobante_tipo}
                        </p>

                        {
                            pedido.comprobante_tipo == "01" && (
                                <p>
                                    <span class="font-medium">RUC:</span>
                                    {pedido.comprobante_ruc}
                                </p>

                                <p>
                                    <span class="font-medium">Razón social:</span>
                                    {pedido.comprobante_razon_social}
                                </p>
                            )
                        }

                        <p>
                            <span class="font-medium">Método de pago:</span>
                            {pedido.pago_metodo}
                        </p>

                        <p>
                            <span class="font-medium">Monto total:</span>
                            {pedido.moneda1?.simbolo}{pedido.monto}
                        </p>
                    </div>

                    <div>
                        <div class="mb-2">
                            <span class="font-medium">Productos:</span>
                        </div>

                        <div class="space-y-4 mb-6">
                            {
                                pedido.socio_pedido_items.map((item) => (
                                    <div class="flex gap-4 border-b border-gray-200 pb-3">
                                        <img
                                            src={item.articulo1.fotos[0]?.url}
                                            alt="Producto"
                                            class="w-16 h-16 object-cover rounded-lg border border-gray-200"
                                        />
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-gray-800 leading-tight">
                                                {item.nombre}
                                            </p>

                                            <div class="flex justify-between">
                                                <p class="text-xs text-gray-500">
                                                    Cantidad: {item.cantidad}
                                                </p>

                                                <p class="text-sm font-semibold text-gray-700 mt-1">
                                                    S/
                                                    {(
                                                        item.pu * item.cantidad
                                                    ).toFixed(2)}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                </section>

                <div>
                    <!-- Etapas -->
                    <aside class="bg-white p-8 rounded-2xl shadow-md h-fit">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6">
                            Etapas del Pedido
                        </h2>
    
                        <ol class="space-y-4">
                            {
                                etapas.map((etapa) => {
                                    const activa = etapa.fecha !== null;
                                    return (
                                        <li class="flex items-start gap-3">
                                            <div
                                                class={`w-4 h-4 rounded-full mt-1 ${
                                                    activa
                                                        ? "bg-green-500"
                                                        : "bg-gray-300"
                                                }`}
                                            />
                                            <div>
                                                <p
                                                    class={`font-medium ${activa ? "text-green-700" : "text-gray-500"}`}
                                                >
                                                    {etapa.nombre}
                                                </p>
                                                {activa && (
                                                    <p class="text-xs text-gray-500">
                                                        {new Date(
                                                            etapa.fecha,
                                                        ).toLocaleString("es-PE", {
                                                            dateStyle: "short",
                                                            timeStyle: "short",
                                                        })}
                                                    </p>
                                                )}
                                            </div>
                                        </li>
                                    );
                                })
                            }
                        </ol>
                    </aside>

                    <div class="flex justify-center gap-4 mt-4">
                        {
                            is_account == 'true' ? (
                                <a href="/account#pedidos" class="button button2">
                                    Ver mis pedidos
                                </a>
                            ) : (
                                <a href="/consultar-pedido" class="button button2">
                                    Consultar otro pedido
                                </a>
                            )
                        }

                        <a href="/linea/filtrante" class="button button1">
                            Ver productos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <Beneficios/>
</BaseLayout>
