---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProductoFotos from '../../components/ProductoFotos.vue';
import ShoppingCartPlus from '../../assets/icons/shopping-cart-plus.vue';
import ProductosCarrusel from '../../components/ProductosCarrusel.vue';
import Beneficios from '../../components/Beneficios.astro';
import BrandFacebookIcon from '../../assets/icons/brand-facebook.astro';
import BrandPinterestIcon from '../../assets/icons/brand-pinterest.astro';
import BrandWhatsappIcon from '../../assets/icons/brand-whatsapp.astro';
import MailIcon from '../../assets/icons/mail.astro';
import AddToCart from '../../components/AddToCart.vue';
import { getProductos } from '../../lib/api.js';

const { slug } = Astro.params;
const productos = await getProductos({ id: { op: 'Es', val: slug } }, null, [
    'contenido_neto',
    'descripcion',
    'ingredientes',
    'beneficios',
    'dimenciones',
    'envase_tipo',
]);
const producto = productos[0];

const productosRelacionados = await getProductos({
    categoria: { op: 'Es', val: producto.categoria },
});

const producto_nombre = producto.nombre;
---

<BaseLayout title={`Producto: ${producto_nombre}`}>
    <section
        class="w-full px-4 md:px-10 py-10 flex flex-col md:flex-row gap-12"
    >
        <!-- Fotos -->
        <div class="flex-[2]">
            <ProductoFotos producto={producto} client:load />
        </div>

        <!-- Información -->
        <div class="producto-info flex-[1.5] flex flex-col justify-between">
            <div>
                <!-- Línea / categoría -->
                <p class="text-sm uppercase text-gray-500 tracking-wider mb-2">
                    {producto.produccion_tipo1.nombre} | {
                        producto.categoria1.nombre
                    }
                </p>

                <!-- Nombre -->
                <h1
                    class="text-2xl md:text-3xl font-semibold mb-4 text-gray-900 leading-tight"
                >
                    {producto.nombre}
                </h1>

                <!-- Reseñas -->
                <div class="flex items-center gap-1 mb-3">
                    <span class="text-yellow-400">★★★★★</span>
                    <span class="text-sm text-gray-500">(12 reseñas)</span>
                </div>

                <!-- Precio -->
                <div class="mb-3">
                    <div class="flex items-baseline gap-2">
                        <span class="text-3xl font-semibold text-gray-900">
                            S/ {producto.precio}
                        </span>
                        {
                            producto.precio_antes && (
                                <span class="text-gray-400 line-through text-lg">
                                    S/ {producto.precio_antes}
                                </span>
                            )
                        }
                    </div>
                    <p class="text-sm text-gray-500">Impuestos incluidos</p>
                </div>

                <!-- Descripción -->
                <p class="text-gray-700 leading-relaxed mb-6">
                    {producto.descripcion}
                </p>

                <AddToCart producto={producto} client:load />
            </div>

            <!-- Compartir -->
            <div class="mt-8 border-t border-gray-200 pt-6">
                <p class="text-sm uppercase text-gray-500 mb-4 tracking-wider">
                    Compartir
                </p>

                <div class="flex gap-4">
                    <a
                        data-share="facebook"
                        data-text={producto_nombre}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="w-10 h-10 flex items-center justify-center border border-gray-300 rounded-full hover:bg-gray-100 transition text-gray-600"
                        aria-label="Compartir en Facebook"
                    >
                        <BrandFacebookIcon /></a
                    >

                    <a
                        data-share="pinterest"
                        data-text={producto_nombre}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="w-10 h-10 flex items-center justify-center border border-gray-300 rounded-full hover:bg-gray-100 transition text-gray-600"
                        aria-label="Compartir en Pinterest"
                    >
                        <BrandPinterestIcon /></a
                    >

                    <a
                        data-share="whatsapp"
                        data-text={producto_nombre}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="w-10 h-10 flex items-center justify-center border border-gray-300 rounded-full hover:bg-gray-100 transition text-gray-600"
                        aria-label="Compartir por WhatsApp"
                    >
                        <BrandWhatsappIcon />
                    </a>

                    <a
                        data-share="email"
                        data-text={producto_nombre}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="w-10 h-10 flex items-center justify-center border border-gray-300 rounded-full hover:bg-gray-100 transition text-gray-600"
                        aria-label="Compartir por correo"
                    >
                        <MailIcon />
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="bg-neutral-50 py-16">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2
                class="text-2xl font-semibold text-gray-800 mb-8 border-b pb-2 border-gray-200"
            >
                Información adicional
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-gray-700">
                <div class="flex flex-col gap-4">
                    <div>
                        <h3
                            class="text-sm font-medium text-gray-500 uppercase tracking-wide"
                        >
                            Contenido neto
                        </h3>
                        <p class="text-base font-semibold">
                            {producto.contenido_neto}
                        </p>
                    </div>

                    <div>
                        <h3
                            class="text-sm font-medium text-gray-500 uppercase tracking-wide"
                        >
                            Dimensiones
                        </h3>
                        <p class="text-base font-semibold">
                            {producto.dimenciones}
                        </p>
                    </div>

                    <div>
                        <h3
                            class="text-sm font-medium text-gray-500 uppercase tracking-wide"
                        >
                            Tipo de envase
                        </h3>
                        <p class="text-base font-semibold">
                            {producto.envase_tipo}
                        </p>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div>
                        <h3
                            class="text-sm font-medium text-gray-500 uppercase tracking-wide"
                        >
                            Ingredientes
                        </h3>
                        <ul
                            class="list-disc list-inside space-y-1 text-base leading-relaxed"
                        >
                            {
                                producto.ingredientes.map((item) => (
                                    <li>{item}</li>
                                ))
                            }
                        </ul>
                    </div>

                    <div>
                        <h3
                            class="text-sm font-medium text-gray-500 uppercase tracking-wide"
                        >
                            Beneficios
                        </h3>
                        <ul
                            class="list-disc list-inside space-y-1 text-base leading-relaxed"
                        >
                            {producto.beneficios.map((item) => <li>{item}</li>)}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="max-w-8xl mx-auto px-6 py-16">
        <div class="text-center mb-12">
            <h2
                class="text-3xl md:text-4xl font-heading font-bold text-gray-900"
            >
                Productos similares
            </h2>
            <p class="mt-2 text-gray-600">
                Descubre otros productos que podrían interesarte.
            </p>
        </div>

        <ProductosCarrusel productos={productosRelacionados} client:load />
    </section>

    <Beneficios />
</BaseLayout>

<script>
    // se ejecuta solo en cliente (el navegador)
    const setShareLinks = () => {
        try {
            const url = window.location.href;
            if (!url) return;
            const encUrl = encodeURIComponent(url);
            const text = encodeURIComponent(
                'Descubre nuestro producto ' +
                    document.querySelector('[data-share]')?.dataset?.text
            );

            // mapea los tipos a los templates de sharing
            const templates = {
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encUrl}`,
                pinterest: `https://pinterest.com/pin/create/button/?url=${encUrl}&description=${text}`,
                whatsapp: `https://api.whatsapp.com/send?text=${text}%20${encUrl}`,
                email: `mailto:?subject=${text}&body=${encUrl}`,
            };

            document.querySelectorAll('[data-share]').forEach((el) => {
                const key = el.dataset.share;
                if (templates[key]) {
                    el.setAttribute('href', templates[key]);
                }
            });
        } catch (err) {
            // fail gracefully
            console.warn(
                'No se pudo inicializar los enlaces de compartir:',
                err
            );
        }
    };

    // Ejecutar cuando DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setShareLinks);
    } else {
        setShareLinks();
    }
</script>
